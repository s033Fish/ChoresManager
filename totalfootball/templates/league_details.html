{% extends "base.html" %}

{% block head %}
    <!-- Load Static Files -->
    {% load static %}

    <!-- Custom CSS for this specific page -->
    <link rel="stylesheet" href="{% static 'header.css' %}">
    
    <!-- jQuery and Page-Specific JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            console.log('JavaScript Loaded');

            const csrftoken = '{{ csrf_token }}';

            // Function to poll the draft room status to check who has joined
            function pollDraftRoomStatus() {
                setInterval(function() {
                    console.log('Polling draft room status...');
                    $.ajax({
                        url: '/get_draft_room_status/',
                        type: 'GET',
                        data: { 'league_id': {{ league.id }} },
                        success: function(response) {
                            console.log('Draft room status:', response);
                            let draftRoomMembersHtml = '';
                            response.members.forEach(function(member) {
                                draftRoomMembersHtml += `<li>${member.username}</li>`;
                            });
                            $('#draft-room-members').html(draftRoomMembersHtml);

                            // If all members are in, start the draft
                            if (response.all_ready) {
                                alert('All members are ready. Starting the draft!');
                                window.location.href = '/draft/{{ league.id }}/';
                            }
                        },
                        error: function() {
                            console.error('Failed to get draft room status. Retrying...');
                        }
                    });
                }, 5000); // Poll every 5 seconds
            }

            // Attach event to join draft button if draft is needed                
            $('#join-draft-button').on('click', function() {
                    joinDraftRoom();
            });
        });
    </script>
{% endblock %}

{% block content %}
    <!-- League Details -->
    <div>
        <h1>{{ league.name }}</h1>
        <p>Code: {{ league.code }}</p>

        {% if show_members_for_draft %}
            <h2>League Members (Draft Needed)</h2>
            <ul id="members-list">
                {% for member in league.members.all %}
                    <li>{{ member.username }}</li>
                {% empty %}
                    <li>No members in this league yet.</li>
                {% endfor %}
            </ul>

            <!-- Button to Join Draft Room -->
            <button id="join-draft-button">Join Draft Room</button>

            <h3>Current Draft Room Members:</h3>
            <ul id="draft-room-members">
                <!-- Updated via AJAX polling -->
            </ul>
        {% else %}
            <h2>Teams in this League</h2>
            <ul id="teams-list">
                {% for team in league.league_teams.all %}
                    <li>{{ team.user.username }} - Total Points: {{ team.calculated_points }}</li>
                {% empty %}
                    <li>No teams in this league yet.</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>
    <form method="POST" action="{% url 'start_draft' league.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">Start Draft</button>
    </form>
{% endblock %}
